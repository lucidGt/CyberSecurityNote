# Kerberos-roasting

## 什么是SPN？

SPN（Service Principal Name）域里对某个服务的唯一名字/门牌号。

它把三个东西绑定在一起：

1）服务名（SQL、HTTPS、CIFS）

2）运行服务的主机（SQL01）

3）承载服务得到账号（服务账号）

## 为什么普通域用户能请求TGS？

Kerberos的设计就是：

​	任何已登录的域用户，都可用向DC请求“访问某个服务”的票据（TGS）

这本来是正常的业务：

​	1）你要访问文件共享、数据库、Web服务

​	2）你必须拿到对应的TGS

所以Kerberoast利用的是一个“正常功能”

​	1）不需要管理员权限

​	2）不需要在目标机上执行

​	3）只要你是域用户就能做“请求票据”这件事

## 如何爆破服务账号密码

关键点在这里：

​	TGS里有一部分是用“服务账号的密钥”加密的，而服务账号的密钥来自它的密码

于是能进行离线猜测：

​	1）猜对密码->验证成功

​	2）猜错密码->继续猜

​	3）全程不用再和DC交互（离线）

本质：正常拿到的服务票据，去离线破解“服务账号密码”

## 爆破后能不能升级身份？

爆破一个服务账号有三种价值：

### 1）低价值（只能访问服务）

（1）只能连数据库/访问某个共享

（2）对提权帮助不大

### 2）中价值（能拿下一台关键主机）

（1）在服务所在机器是本地管理员（最常见）

（2）你能落地到那台机器，然后本地提权/拿更多凭据

### 3）高价值（直接接近域控/DA）

服务账号本身权限太大（被加进高权限组、或能控制关键系统）

## 攻击链

1）低权限

2）新身份

3）横向

4）提权

5）DC