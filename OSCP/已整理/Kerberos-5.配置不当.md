# Kerberos-5.配置不当

## 身份与账号配置不当

### 弱口令与密码策略太松

现象：密码过短、无复杂度

风险：任何拿到可爆破材料都容易出结果

### 服务账号用“人用域账号“充当

现象：svc_\*、sql\*之类账号还能交互登录

风险：一个密码既能跑服务又能登录主机、权限扩散很快

### “不需要kerberos预认证”的用户

现象：个别域账号设置为不需要域认证

风险：在密钥域账号时也可能拿到离线爆破的认证材料

### 组成员膨胀

现象：普通看起来的账号在高权限组里（运维组、服务器管理员组等）

风险：表现低权，实际落地就是管理员

## Kerberos与委派相关配置不当

### 过度委派（Delegation）配置

现象：账号/密码被允许代表用户去访问别的服务（委派）

风险：一旦控制相关主体，可能“借身份”去访问更高价值资源

### SPN乱绑/绑到不该绑的账号

现象：普通用户账号被绑定SPN

风险：身份边界模糊，服务账号风险转移到人用账号上

## 权限委派与ACL配置不当

### 对高价值对象的“可写权限”误授

现象：某个普通组/用户能修改其他用户、组、OU、GPO

风险：不需要域管，也能把自己写成域管效果

### 过度使用嵌套组、权限来源不透明

现象：权限来自多层嵌套，管理员自己都说不清谁有权

风险：隐蔽的高权限路径很常见

## 组策略与登录行为配置不当

### 管理员在“非管理机”频繁登录

现象：DA/运维账号在普通服务器/工作站交互登录

风险：高权限身份会在那些机器留下可被再次利用的痕迹

### GPO管理松散

现象：很多人能改GPO，或GPO链接到关键OU

风险：一个策略变更影响一大片机器/用户

## AD CS（证书服务）配置不当

现象：证书模板/注册策略给得过宽，或允许不该允许的主体申请高权限证书

风险：可能绕过传统密码路径，直接获得高权限身份能力

## 网络与服务暴露配置不当

### 共享与文件权限过宽

现象：大量共享对Domain Users可读/可写

风险：配置文件、脚本、自动化任务里常藏票据/链接串

### 管理面暴露过多

现象：很多服务器对所有域用户开放管理入口

风险：一旦拿到稍强身份，横向速度就非常快

## 旧系统与遗留配置

现象：老版本协议/兼容性设置、遗留管理员账号、测试账号未清理

风险：常见“捷径入口”，最容易被忽视

## 最值的优先关注

1.服务账号/SPN相关（Kerberos线）

2.无预认证用户（AS-REP线）

3.组成员异常（权限碰撞）

4.共享/脚本里藏票据

5.管理员登录习惯

## 一些概念

### OU（Organizational Unit）=AD里的分组文件夹

把AD想成一个树形目录，OU就是里面的文件夹，用来装用户，计算机，组

corp.local
 	├── OU=Workstations
	 │     ├── WS01
	 │     └── WS02
	 ├── OU=Servers
 	│     ├── SQL01
	 │     └── FILE01
 	└── OU=Admins
      	 └── admin1

OU两个核心作用

1.方便管理

2.GPO的作用范围锚点

### GPO（Group Policy Object）=能“批量控制用户/机器行为”的策略包

GPO可以干很多事情

1）给机器加本地管理员

2）配置登录脚本

3）设置密码策略

4）启用/禁用服务

5）下发软件、脚本

### GPO是怎么生效的？

GPO会被链接（Link）到：

1）域

2）OU

3）子OU

这个OU里的所有服务器，都会执行这个GPO

### 为什么GPO在攻击很重要

如果一个用户：

1）能修改这个GPO

2）或能给OU链接GPO

就能影响OU内所有机器/用户

### GPO攻击链

谁能修改GPO->就能控制GPO作用范围->就能控制OU里的机器/用户

### AD CS(Active Directory Certificate Services)=域里的证书签发系统

作用：

1）给用户/机器签发数字证书

2）用证书来做：

​		（1）身份认证

​		（2）登录

​		（3）加密

​		（4）签名

很多企业用证书替代部分密码登录

### 为什么AD CS在攻击中很危险

因为在AD里：

“证书”~=“身份凭证”

如果ADCS配置不当

​	1）可能不用知道密码

​	2）就能获得等价于某个用户的身份能力

绕过传统密码路径的身份系统